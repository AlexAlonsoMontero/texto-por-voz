<ion-content class="phrases-page" [fullscreen]="true">
  <div class="phrases-container">
    <!-- Zona superior: input reutilizado con bot√≥n Guardar -->
    <app-text-input-section
      [textContent]="currentText()"
      [showSave]="true"
      (textContentChange)="onTextChange($event)"
      (saveHoldStart)="onSaveHoldStart()"
      (saveAction)="onSaveAction()"
    >
    </app-text-input-section>

    <!-- Grid optimizado 4x4 - 16 Botones -->
    <div class="slots-grid-4x4">
      <app-phrase-slot-button
        *ngFor="let s of slots; let i = index"
        class="slot-item"
        [slot]="s"
        (holdStart)="onSlotHoldStart(i)"
        (action)="onSlotAction(i)"
      ></app-phrase-slot-button>
    </div>

    <!-- Botones de acci√≥n globales (Imagen y Borrar) -->
    <div class="action-buttons-section">
      <app-press-hold-button
        buttonId="manage-images-btn"
        actionId="manage-images"
        color="primary"
        [holdDuration]="2000"
        ariaLabel="Gestionar im√°genes de botones"
        (holdStart)="onImageActionHoldStart()"
        (actionExecuted)="openImageManageModal()"
        class="action-button"
      >
        üì∑ Imagen
      </app-press-hold-button>

      <app-press-hold-button
        buttonId="manage-delete-btn"
        actionId="manage-delete"
        color="danger"
        [holdDuration]="2000"
        ariaLabel="Eliminar botones"
        (holdStart)="onDeleteActionHoldStart()"
        (actionExecuted)="openDeleteManageModal()"
        class="action-button"
      >
        üóëÔ∏è Borrar
      </app-press-hold-button>
    </div>
  </div>

  <!-- Modal para elegir n√∫mero (guardar/sobrescribir) - Dise√±o compacto -->
  <ion-modal [isOpen]="showSaveModal" [backdropDismiss]="false" (ionModalDidDismiss)="onCloseModalAction()">
    <ng-template>
      <div class="modal-content compact-modal">
        <div class="modal-inner">
          <div class="modal-header">
            <h2 class="modal-title">Selecciona bot√≥n</h2>
            <p class="modal-subtitle">Mant√©n presionado para guardar</p>
          </div>

          <div class="compact-grid-wrapper">
            <div class="compact-slots-grid">
              <app-press-hold-button
                *ngFor="let s of slots; let i = index"
                class="compact-slot-btn"
                [buttonId]="'pick-btn-' + (i + 1)"
                [actionId]="'pick-' + (i + 1)"
                [color]="s.value ? 'warning' : 'primary'"
                [holdDuration]="2000"
                [ariaLabel]="'Seleccionar bot√≥n ' + (i + 1) + (s.value ? ' (reemplazar)' : ' (vac√≠o)')"
                (holdStart)="onPickSlotHoldStart(i)"
                (actionExecuted)="onPickSlotAction(i)"
              >
                <div class="compact-slot-content">
                  <span class="compact-number">{{ i + 1 }}</span>
                  <ion-icon *ngIf="s.value" name="warning" class="occupied-icon"></ion-icon>
                </div>
              </app-press-hold-button>
            </div>
          </div>

          <div class="modal-actions">
            <app-press-hold-button
              [buttonId]="'close-modal'"
              [actionId]="'close-modal-action'"
              color="medium"
              [holdDuration]="2000"
              ariaLabel="Cerrar"
              (holdStart)="onCloseModalHoldStart()"
              (actionExecuted)="onCloseModalAction()"
            >
              Cerrar
            </app-press-hold-button>
          </div>
        </div>
      </div>
    </ng-template>
  </ion-modal>

  <!-- Modal de gesti√≥n de im√°genes (seleccionar slot) -->
  <ion-modal [isOpen]="showImageManageModal" [backdropDismiss]="false" (ionModalDidDismiss)="closeImageManageModal()">
    <ng-template>
      <ion-content class="modal-content">
        <div class="modal-inner">
          <div class="modal-header">
            <h2 class="modal-title">Gestionar Im√°genes</h2>
            <p class="modal-subtitle">Selecciona un bot√≥n</p>
          </div>

          <div class="slots-grid-modal">
            <app-press-hold-button
              *ngFor="let item of slots; let i = index"
              [buttonId]="'image-manage-' + (i + 1)"
              [actionId]="'image-manage-' + (i + 1)"
              color="primary"
              [holdDuration]="2000"
              [ariaLabel]="'Gestionar imagen del bot√≥n ' + (i + 1)"
              (actionExecuted)="openImageConfig(i)"
              class="modal-slot-btn"
            >
              <div class="modal-slot-content">
                <!-- Mostrar imagen si existe -->
                <img
                  *ngIf="slots[i].imageUri"
                  [src]="getImageSrc(slots[i].imageUri)"
                  [alt]="'Bot√≥n ' + (i + 1)"
                  class="modal-slot-image"
                />
                <!-- Mostrar n√∫mero si NO hay imagen -->
                <span *ngIf="!slots[i].imageUri" class="modal-slot-number">{{ i + 1 }}</span>
                <!-- Indicador de imagen -->
                <ion-icon *ngIf="slots[i].imageUri" name="image" class="has-image-icon"></ion-icon>
              </div>
            </app-press-hold-button>
          </div>

          <div class="modal-actions">
            <app-press-hold-button
              buttonId="close-image-manage"
              actionId="close-image-manage"
              color="medium"
              [holdDuration]="2000"
              ariaLabel="Cancelar"
              (actionExecuted)="closeImageManageModal()"
            >
              Cancelar
            </app-press-hold-button>
          </div>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Modal de configuraci√≥n de imagen -->
  <ion-modal
    [isOpen]="currentConfigIndex >= 0 && !showImageManageModal"
    [backdropDismiss]="false"
    (ionModalDidDismiss)="closeImageConfig()"
  >
    <ng-template>
      <ion-content class="modal-content">
        <div class="modal-inner">
          <div class="modal-header">
            <h2 class="modal-title">Configurar Imagen del Bot√≥n {{ currentConfigIndex + 1 }}</h2>
          </div>

                    <div class="image-config-layout">
            <!-- Columna Izquierda: Previsualizaci√≥n -->
            <div class="config-preview-section">
              <div class="current-preview" [class.no-image]="!getCurrentSlot()?.imageUri">
                <img
                  *ngIf="getCurrentSlot()?.imageUri"
                  [src]="getImageSrc(getCurrentSlot()?.imageUri)"
                  alt="Previsualizaci√≥n"
                  class="preview-image"
                />
                <span *ngIf="!getCurrentSlot()?.imageUri" class="slot-number">{{ currentConfigIndex + 1 }}</span>
              </div>
            </div>

            <!-- Columna Derecha: Acciones -->
            <div class="config-actions-section">
              <!-- Bot√≥n para seleccionar imagen -->
              <app-press-hold-button
                buttonId="select-image-btn"
                actionId="select-image"
                color="primary"
                [holdDuration]="2000"
                ariaLabel="Seleccionar imagen de la galer√≠a"
                (holdStart)="onSelectImageHoldStart()"
                (actionExecuted)="selectImageFromGallery()"
                class="config-action-btn"
              >
                üì∑ Seleccionar de Galer√≠a
              </app-press-hold-button>

              <!-- Bot√≥n para quitar imagen (solo si hay imagen) -->
              <app-press-hold-button
                *ngIf="getCurrentSlot()?.imageUri"
                buttonId="remove-image-btn"
                actionId="remove-image"
                color="danger"
                [holdDuration]="2000"
                ariaLabel="Quitar imagen y volver a mostrar n√∫mero"
                (holdStart)="onRemoveImageHoldStart()"
                (actionExecuted)="removeImage()"
                class="config-action-btn"
              >
                üóëÔ∏è Quitar Imagen
              </app-press-hold-button>

              <!-- Bot√≥n Cerrar (Movido aqu√≠) -->
              <app-press-hold-button
                buttonId="close-image-config"
                actionId="close-image-config"
                color="medium"
                [holdDuration]="2000"
                ariaLabel="Cerrar configuraci√≥n de imagen"
                (actionExecuted)="closeImageConfig()"
                class="config-action-btn"
              >
                Cerrar
              </app-press-hold-button>
            </div>
        </div>
      </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Modal de gesti√≥n de borrados (seleccionar slot) -->
  <ion-modal [isOpen]="showDeleteManageModal" [backdropDismiss]="false" (ionModalDidDismiss)="closeDeleteManageModal()">
    <ng-template>
      <ion-content class="modal-content">
        <div class="modal-inner">
          <div class="modal-header">
            <h2 class="modal-title">Eliminar Botones</h2>
            <p class="modal-subtitle">Selecciona un bot√≥n para borrar</p>
          </div>

          <div class="slots-grid-modal">
            <app-press-hold-button
              *ngFor="let s of slots; let i = index"
              [buttonId]="'delete-manage-' + (i + 1)"
              [actionId]="'delete-manage-' + (i + 1)"
              [color]="(s.value || s.imageUri) ? 'danger' : 'medium'"
              [holdDuration]="2000"
              [ariaLabel]="'Eliminar bot√≥n ' + (i + 1)"
              (actionExecuted)="onDeleteSlotSelected(i)"
              class="modal-slot-btn"
            >
              <div class="modal-slot-content">
                <!-- Mostrar imagen si existe -->
                <img *ngIf="s.imageUri" [src]="getImageSrc(s.imageUri)" [alt]="'Bot√≥n ' + (i + 1)" class="modal-slot-image" />
                <!-- Mostrar n√∫mero si NO hay imagen -->
                <span *ngIf="!s.imageUri" class="modal-slot-number">{{ i + 1 }}</span>
              </div>
            </app-press-hold-button>
          </div>

          <div class="modal-actions">
            <app-press-hold-button
              buttonId="close-delete-manage"
              actionId="close-delete-manage"
              color="medium"
              [holdDuration]="2000"
              ariaLabel="Cancelar"
              (actionExecuted)="closeDeleteManageModal()"
            >
              Cancelar
            </app-press-hold-button>
          </div>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Modal de confirmaci√≥n de borrado -->
  <ion-modal
    [isOpen]="showDeleteConfirmModal"
    [backdropDismiss]="false"
    (ionModalDidDismiss)="closeDeleteConfirmModal()"
  >
    <ng-template>
      <ion-content class="modal-content">
        <div class="modal-inner">
          <div class="modal-header">
            <h2 class="modal-title">Confirmar Borrado</h2>
            <p class="modal-subtitle">¬øBorrar bot√≥n {{ slotToDeleteIndex + 1 }}?</p>
          </div>

          <div class="confirm-layout">
            <!-- Columna Izquierda: Previsualizaci√≥n -->
            <div class="confirm-preview-section">
              <div class="confirm-slot-preview" *ngIf="slots[slotToDeleteIndex]?.imageUri">
                <img [src]="getImageSrc(slots[slotToDeleteIndex]!.imageUri)" alt="Confirmar" class="preview-image" />
                <p class="preview-text">{{ slots[slotToDeleteIndex]?.value }}</p>
              </div>
              <div class="confirm-slot-preview no-image" *ngIf="!slots[slotToDeleteIndex]?.imageUri">
                <span class="slot-number">{{ slotToDeleteIndex + 1 }}</span>
                <p class="preview-text">{{ slots[slotToDeleteIndex]?.value }}</p>
              </div>
            </div>

            <!-- Columna Derecha: Acciones -->
            <div class="confirm-actions-section">
              <app-press-hold-button
                buttonId="confirm-delete-btn"
                actionId="confirm-delete"
                color="danger"
                [holdDuration]="2000"
                ariaLabel="Confirmar borrado. Mant√©n presionado"
                (holdStart)="onConfirmDeleteHoldStart()"
                (actionExecuted)="confirmDeleteSlot()"
                class="confirm-action-btn"
              >
                ‚úì Confirmar Borrado
              </app-press-hold-button>

              <app-press-hold-button
                buttonId="cancel-delete-btn"
                actionId="cancel-delete"
                color="medium"
                [holdDuration]="2000"
                ariaLabel="Cancelar borrado"
                (actionExecuted)="closeDeleteConfirmModal()"
                class="confirm-action-btn"
              >
                ‚úó Cancelar
              </app-press-hold-button>
            </div>
          </div>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
